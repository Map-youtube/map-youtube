<script>
    let map, currentInfoWindow;
    const markers = [];

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 15, lng: 150 },
            zoom: 3,
        });

        fetch("https://raw.githubusercontent.com/Map-youtube/map-youtube/main/location.xlsx")
            .then(response => response.arrayBuffer())
            .then(data => {
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);

                jsonData.forEach(location => {
                    const latLngString = location['latitude, longitude'];
                    const [lat, lng] = latLngString.split(',').map(coord => parseFloat(coord.trim()));
                    const place = location.Location;
                    const city = location.CITY;
                    const country = location.COUNTRY;
                    const category = location.Category || "";
                    const videoID = location['YouTube Link'];
                    const embedURL = `https://www.youtube.com/embed/${videoID}?rel=0&showinfo=0&autoplay=1&mute=1`;
                    const locationDescription = `${place}, ${city}, ${country}`;

                    const marker = new google.maps.Marker({
                        position: { lat, lng },
                        title: locationDescription
                    });

                    const shortInfoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="info-window">
                                <h3>${place}</h3>
                                <p>${city}, ${country}</p>
                                <p class="small-text">${category}</p>
                            </div>
                        `
                    });

                    const fullInfoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="info-window">
                                <h3>${locationDescription}</h3>
                                <iframe src="${embedURL}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                                <p class="small-text">${category}</p>
                            </div>`
                    });

                    marker.addListener("mouseover", () => {
                        shortInfoWindow.open({
                            anchor: marker,
                            map,
                            shouldFocus: false,
                        });
                    });

                    marker.addListener("mouseout", () => {
                        shortInfoWindow.close();
                    });

                    marker.addListener("click", () => {
                        if (currentInfoWindow) {
                            currentInfoWindow.close();
                        }
                        shortInfoWindow.close();
                        fullInfoWindow.open({
                            anchor: marker,
                            map,
                            shouldFocus: false,
                        });
                        currentInfoWindow = fullInfoWindow;
                    });

                    markers.push(marker);
                });

                const markerCluster = new markerClusterer.MarkerClusterer({ map, markers });
                google.maps.event.addListener(markerCluster, 'clusterclick', (cluster) => {
                    const clusterBounds = cluster.getBounds();
                    map.fitBounds(clusterBounds);
                });
            })
            .catch(error => console.error("Error loading the XLSX file:", error));
    }

    window.onload = initMap;
</script>
